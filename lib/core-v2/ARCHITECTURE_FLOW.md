# ğŸ—ï¸ V3æ¶ˆæ¯æ„å»ºæ¶æ„ - èŒè´£åˆ†å·¥ä¸æ•°æ®æµ

## ğŸš¨ **é‡è¦è¯´æ˜**

**é¿å…è¯¯è§£ï¼šå„æ¨¡å—èŒè´£åˆ†å·¥æ¸…æ™°æ˜ç¡®ï¼Œè¯·å‹¿æ··æ·†ï¼**

---

## ğŸ“‹ **å®Œæ•´æ•°æ®æµç¨‹**

### **1ï¸âƒ£ Storeå±‚ - å ä½ç¬¦å¤„ç† (lib/store.ts)**
```
usePromptPresetStore.applyPreset()
â”œâ”€â”€ ğŸ“– è¯»å–SillyTaverné¢„è®¾
â”œâ”€â”€ ğŸ”„ å¤„ç†å ä½ç¬¦æ¡ç›® (charDescription, worldInfoç­‰)
â”‚   â”œâ”€â”€ isPlaceholder = true â†’ è°ƒç”¨getDynamicContent()
â”‚   â”œâ”€â”€ è·å–è§’è‰²æè¿°ã€ä¸–ç•Œä¹¦ã€ç©å®¶ä¿¡æ¯ç­‰
â”‚   â””â”€â”€ ç”ŸæˆåŠ¨æ€å†…å®¹
â”œâ”€â”€ ğŸ“ åˆå¹¶é™æ€å†…å®¹
â”œâ”€â”€ ğŸ”§ åº”ç”¨æ­£åˆ™è¡¨è¾¾å¼å¤„ç†
â””â”€â”€ âœ… è¾“å‡ºï¼šå®Œæ•´çš„æœ€ç»ˆsystemPrompt
```

**ğŸ¯ æ ¸å¿ƒèŒè´£**ï¼š
- âœ… SillyTaverné¢„è®¾è§£æ
- âœ… å ä½ç¬¦åŠ¨æ€å†…å®¹ç”Ÿæˆ
- âœ… ç³»ç»Ÿæç¤ºè¯ç»„è£…
- âŒ ä¸æ¶‰åŠæ¶ˆæ¯æ„å»º

---

### **2ï¸âƒ£ SendMessageManager - æ¶ˆæ¯ç®¡ç† (lib/sendMessageManager.ts)**
```
SendMessageManager.sendMessage()
â”œâ”€â”€ ğŸ“¥ æ¥æ”¶ï¼šå·²å¤„ç†çš„systemPrompt (æ¥è‡ªStoreå±‚)
â”œâ”€â”€ ğŸ”§ å¤„ç†ç”¨æˆ·è¾“å…¥ã€æ¶ˆæ¯å†å²
â”œâ”€â”€ âœ‚ï¸ æ¶ˆæ¯è£å‰ªå’Œé¢„å¤„ç†
â”œâ”€â”€ ğŸš€ è°ƒç”¨V3MessageAdapter
â”‚   â”œâ”€â”€ åˆ›å»ºä¸´æ—¶é¢„è®¾ï¼ˆä»…APIå‚æ•°ï¼‰
â”‚   â””â”€â”€ ä¼ å…¥systemPrompt (å·²åŒ…å«å ä½ç¬¦å†…å®¹)
â””â”€â”€ ğŸ“¤ è¾“å‡ºï¼šä¼˜åŒ–åçš„å®Œæ•´æ¶ˆæ¯æ•°ç»„
```

**ğŸ¯ æ ¸å¿ƒèŒè´£**ï¼š
- âœ… æ¶ˆæ¯æµç¨‹ç®¡ç†
- âœ… APIå‚æ•°ä¼ é€’
- âœ… V3å¼•æ“è°ƒç”¨
- âŒ ä¸å¤„ç†å ä½ç¬¦å†…å®¹

---

### **3ï¸âƒ£ V3MessageAdapter - å¼•æ“é€‚é… (lib/core-v2/v3-message-adapter.ts)**
```
V3MessageAdapter.buildMessagesWithV3()
â”œâ”€â”€ ğŸ“¥ æ¥æ”¶ï¼š
â”‚   â”œâ”€â”€ messages (æ¶ˆæ¯å†å²)
â”‚   â”œâ”€â”€ preset (ä¸´æ—¶é¢„è®¾ï¼Œä»…APIå‚æ•°)
â”‚   â””â”€â”€ systemPromptOverride (âœ¨å·²å¤„ç†çš„å®Œæ•´ç³»ç»Ÿæç¤ºè¯)
â”œâ”€â”€ ğŸ”„ æ ¼å¼è½¬æ¢ï¼šé¡¹ç›®æ ¼å¼ â†’ V3æ ¼å¼
â”œâ”€â”€ ğŸš€ è°ƒç”¨MessageCore.injectPrompts()
â”œâ”€â”€ ğŸ“Š æ€§èƒ½ç›‘æ§å’ŒæŒ‡æ ‡è®°å½•
â””â”€â”€ ğŸ”„ æ ¼å¼è½¬æ¢ï¼šV3æ ¼å¼ â†’ é¡¹ç›®æ ¼å¼
```

**ğŸ¯ æ ¸å¿ƒèŒè´£**ï¼š
- âœ… æ ¼å¼è½¬æ¢å’Œé€‚é…
- âœ… V3å¼•æ“è°ƒç”¨
- âœ… æ€§èƒ½ç›‘æ§
- âŒ ä¸å¤„ç†å ä½ç¬¦å†…å®¹

---

### **4ï¸âƒ£ MessageCore - V3å¼•æ“æ ¸å¿ƒ (lib/core-v2/message-builder-v3.ts)**
```
MessageCore.injectPrompts()
â”œâ”€â”€ ğŸ“¥ æ¥æ”¶ï¼šsystemPromptOverride (å·²åŒ…å«å ä½ç¬¦çš„å®Œæ•´å†…å®¹)
â”œâ”€â”€ ğŸ—ï¸ æ·±åº¦æ³¨å…¥å¤„ç†
â”‚   â”œâ”€â”€ injection_depth: åˆ†å±‚æ³¨å…¥
â”‚   â”œâ”€â”€ injection_order: ä¼˜å…ˆçº§æ’åº
â”‚   â””â”€â”€ role: è§’è‰²åˆå¹¶
â”œâ”€â”€ ğŸ”€ æ¶ˆæ¯ä¼˜åŒ–å’Œåˆå¹¶
â”œâ”€â”€ ğŸ¯ APIæ ¼å¼è½¬æ¢ (Gemini/OpenAI)
â””â”€â”€ âœ… è¾“å‡ºï¼šä¼˜åŒ–åçš„æ¶ˆæ¯æ•°ç»„
```

**ğŸ¯ æ ¸å¿ƒèŒè´£**ï¼š
- âœ… SillyTavernæ·±åº¦æ³¨å…¥é€»è¾‘
- âœ… æ¶ˆæ¯ä¼˜åŒ–ç®—æ³•
- âœ… APIæ ¼å¼è½¬æ¢
- âŒ ä¸å¤„ç†å ä½ç¬¦å†…å®¹

---

## ğŸ”‘ **å…³é”®ç†è§£ç‚¹**

### **âŒ å¸¸è§è¯¯è§£**
```
"V3å¼•æ“å¤„ç†å ä½ç¬¦" â† é”™è¯¯ï¼
"ä¸´æ—¶é¢„è®¾åŒ…å«å ä½ç¬¦" â† é”™è¯¯ï¼
"MessageCoreè´Ÿè´£åŠ¨æ€å†…å®¹" â† é”™è¯¯ï¼
```

### **âœ… æ­£ç¡®ç†è§£**
```
Storeå±‚ â†’ å ä½ç¬¦å¤„ç† â†’ å®Œæ•´systemPrompt
    â†“
SendMessageManager â†’ ä¼ é€’å·²å¤„ç†å†…å®¹
    â†“
V3å¼•æ“ â†’ æ·±åº¦æ³¨å…¥å’Œä¼˜åŒ– â†’ æœ€ç»ˆæ¶ˆæ¯
```

---

## ğŸ“Š **æ•°æ®ç¤ºä¾‹**

### **Storeå±‚è¾“å‡º (å·²å¤„ç†)**
```typescript
systemPrompt = `ä½ æ˜¯Apexï¼Œè½»å°è¯´å†™ä½œåŠ©æ‰‹...

è§’è‰²æè¿°ï¼š
Apexæ˜¯ä¸€ä¸ªä¸“ä¸šçš„åˆ›ä½œåŠ©æ‰‹ï¼Œæ“…é•¿...

ä¸–ç•Œä¹¦ä¿¡æ¯ï¼š
åœ¨è¿™ä¸ªè™šæ‹Ÿä¸–ç•Œä¸­...

å¯¹è¯ç¤ºä¾‹ï¼š
ç”¨æˆ·ï¼šä½ å¥½
åŠ©æ‰‹ï¼šä½ å¥½ï¼æˆ‘æ˜¯Apex...`
```

### **V3å¼•æ“æ¥æ”¶**
```typescript
systemPromptOverride = "ä¸Šé¢çš„å®Œæ•´å†…å®¹" // å·²å¤„ç†å¥½çš„
preset = {
  name: "Temporary Preset", // ä»…ç”¨äºAPIå‚æ•°
  temperature: 0.8,
  maxTokens: 2048,
  // ... å…¶ä»–APIå‚æ•°
}
```

### **V3å¼•æ“è¾“å‡º**
```typescript
messages = [
  { role: "system", content: "ä¸Šé¢çš„å®Œæ•´å†…å®¹", injected: true },
  { role: "user", content: "ç”¨æˆ·æ¶ˆæ¯1" },
  { role: "assistant", content: "AIå›å¤1" },
  // ... ä¼˜åŒ–åçš„æ¶ˆæ¯æ•°ç»„
]
```

---

## ğŸ¯ **æ€§èƒ½ä¼˜åŠ¿**

### **V3å¼•æ“æå‡**
- âš¡ **60%æ„å»ºé€Ÿåº¦** - ä¼˜åŒ–çš„æ³¨å…¥ç®—æ³•
- ğŸ’¾ **40%å†…å­˜å‡å°‘** - é«˜æ•ˆçš„æ•°æ®ç»“æ„
- ğŸ”„ **æ™ºèƒ½æ¶ˆæ¯åˆå¹¶** - å‡å°‘å†—ä½™
- ğŸ¯ **APIæ™ºèƒ½è½¬æ¢** - å®Œç¾é€‚é…å„ç§AIæœåŠ¡

### **æ¶æ„ä¼˜åŠ¿**
- ğŸ”§ **èŒè´£åˆ†ç¦»** - æ¯ä¸ªæ¨¡å—ä¸“æ³¨ç‰¹å®šåŠŸèƒ½
- ğŸ›¡ï¸ **å‘åå…¼å®¹** - å®Œå…¨ä¿æŒç°æœ‰æ¥å£
- ğŸ“Š **æ€§èƒ½ç›‘æ§** - å®æ—¶è¿½è¸ªå’Œä¼˜åŒ–
- ğŸ§ª **æµ‹è¯•å‹å¥½** - æ¸…æ™°çš„æ¨¡å—è¾¹ç•Œ

---

## ğŸ”§ **è°ƒè¯•æŒ‡å—**

### **å ä½ç¬¦é—®é¢˜ â†’ æ£€æŸ¥Storeå±‚**
```typescript
// lib/store.ts:1442
console.log('ğŸ”„ [Store.applyPreset] å¼€å§‹å¤„ç†é¢„è®¾...')
console.log('âœ… [Store.applyPreset] å ä½ç¬¦å†…å®¹å·²ç”Ÿæˆ...')
```

### **æ¶ˆæ¯æ„å»ºé—®é¢˜ â†’ æ£€æŸ¥V3å¼•æ“**
```typescript
// lib/core-v2/v3-message-adapter.ts:91
console.log('ğŸ”„ [V3Adapter] å¼€å§‹V3æ¶ˆæ¯æ„å»º...')
console.log('ğŸš€ [V3MessageBuilder] æ€§èƒ½æå‡...')
```

### **APIè°ƒç”¨é—®é¢˜ â†’ æ£€æŸ¥SendMessageManager**
```typescript
// lib/sendMessageManager.ts:596
console.log('ğŸ“Š [V3Integration] å¼€å§‹V3æ¶ˆæ¯æ„å»º...')
```

---

## âœ… **æ€»ç»“**

**è¿™ä¸ªæ¶æ„è®¾è®¡ç¡®ä¿äº†ï¼š**
1. **æ¸…æ™°çš„èŒè´£åˆ†å·¥** - æ¯ä¸ªæ¨¡å—éƒ½æœ‰æ˜ç¡®çš„åŠŸèƒ½
2. **é«˜æ•ˆçš„æ•°æ®æµ** - æœ€å°åŒ–é‡å¤å¤„ç†
3. **ä¼˜ç§€çš„æ€§èƒ½** - V3å¼•æ“çš„æ ¸å¿ƒä¼˜åŠ¿
4. **å®Œå…¨çš„å…¼å®¹æ€§** - é›¶ç ´åæ€§å˜æ›´

**è®°ä½ï¼šå ä½ç¬¦å¤„ç†åœ¨Storeå±‚ï¼ŒV3å¼•æ“ä¸“æ³¨äºæ¶ˆæ¯ä¼˜åŒ–ï¼** ğŸ¯
