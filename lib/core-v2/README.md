# ğŸš€ Core V2 - SillyTavernå…¼å®¹çš„AIå¯¹è¯ç³»ç»Ÿæ ¸å¿ƒ

æœ¬ç›®å½•åŒ…å«äº†ç»è¿‡æ·±åº¦ç ”ç©¶SillyTavernæºç åï¼Œé‡æ–°è®¾è®¡çš„æ ¸å¿ƒç³»ç»Ÿç»„ä»¶ã€‚ç›®æ ‡æ˜¯å®ç°ä¸SillyTavernå®Œå…¨å…¼å®¹çš„é¢„è®¾å¤„ç†å’Œæ¶ˆæ¯æ„å»ºæœºåˆ¶ï¼ŒåŒæ—¶ä¿æŒä»£ç çš„ç°ä»£æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

## ğŸ“‹ å·²å®Œæˆçš„ç»„ä»¶

### ğŸ¯ 1. é¢„è®¾ç³»ç»ŸV2 (`preset-system-v2.ts`)
- **å®Œæ•´çš„SillyTaverné¢„è®¾å…¼å®¹æ€§**
- æ­£ç¡®è§£æ `injection_depth`ã€`injection_order`ã€`role` ç­‰å…³é”®å­—æ®µ
- æ”¯æŒ `prompt_order` æ’åºé…ç½®
- APIå‚æ•°è¿‡æ»¤å’Œæ˜ å°„ (Gemini vs OpenAI)
- å®Œæ•´çš„é¢„è®¾éªŒè¯å’Œè°ƒè¯•åŠŸèƒ½

**å…³é”®ç‰¹æ€§ï¼š**
- âœ… 100% SillyTaverné¢„è®¾æ ¼å¼å…¼å®¹
- âœ… è‡ªåŠ¨APIå‚æ•°æ˜ å°„ (`max_tokens` â†” `maxOutputTokens`)
- âœ… æç¤ºè¯æ’åºå’Œä¼˜å…ˆçº§æ§åˆ¶
- âœ… è°ƒè¯•å’ŒéªŒè¯å·¥å…·

### ğŸ› ï¸ 2. æ¶ˆæ¯æ„å»ºå™¨V2 (`message-builder-v2.ts`)
- **åˆ†å±‚æ·±åº¦æ³¨å…¥æœºåˆ¶** - å®Œå…¨æ¨¡æ‹ŸSillyTavernçš„æ¶ˆæ¯æ„å»ºé€»è¾‘
- **å¤šAPIå…¼å®¹æ€§** - Gemini, OpenAI, è‡ªå®šä¹‰API
- **Geminiç‰¹æ®Šå¤„ç†** - Systemè§’è‰²è½¬æ¢ï¼Œæ¶ˆæ¯åˆå¹¶
- **æ€§èƒ½ä¼˜åŒ–** - ç›¸æ¯”å¤æ‚çš„SendMessageManagerï¼Œå¤§å¹…æå‡æ€§èƒ½

**æ ¸å¿ƒç®—æ³•ï¼š**
1. æŒ‰ `injection_depth` åˆ†å±‚å¤„ç† (0â†’æœ€å¤§æ·±åº¦)
2. æŒ‰ `injection_order` ä¼˜å…ˆçº§æ’åº (æ•°å€¼å°ä¼˜å…ˆ)
3. æŒ‰ `role` é¡ºåºæ³¨å…¥ (system â†’ user â†’ assistant)
4. æ ¹æ®APIç±»å‹è¿›è¡Œæ ¼å¼è½¬æ¢

**APIå…¼å®¹æ€§ï¼š**
- **Gemini**: Systemæ¶ˆæ¯ â†’ `systemInstruction`ï¼Œè§’è‰²è½¬æ¢ (`assistant` â†’ `model`)
- **OpenAI**: ä¿æŒæ ‡å‡†Chat Completionæ ¼å¼
- **è‡ªå®šä¹‰**: å¯é…ç½®çš„å¤„ç†æ–¹å¼

### ğŸ§ª 3. æµ‹è¯•å¥—ä»¶ (`test-message-builder.ts`, `test-preset.ts`)
- **å…¨é¢çš„åŠŸèƒ½æµ‹è¯•** - æ·±åº¦æ³¨å…¥ã€APIè½¬æ¢ã€å‚æ•°æ˜ å°„
- **æ€§èƒ½åŸºå‡†æµ‹è¯•** - ä¸åŸç³»ç»Ÿçš„æ€§èƒ½å¯¹æ¯”
- **å…¼å®¹æ€§éªŒè¯** - çœŸå®SillyTaverné¢„è®¾æ–‡ä»¶æµ‹è¯•
- **è°ƒè¯•å·¥å…·** - è¯¦ç»†çš„æ„å»ºè¿‡ç¨‹å¯è§†åŒ–

### ğŸ”§ 4. é›†æˆé€‚é…å™¨ (`integration-example-v2.ts`)
- **æ— ç¼è¿ç§»** - ç°æœ‰é¡¹ç›®é›¶æ”¹åŠ¨é›†æˆ
- **æ ¼å¼è½¬æ¢** - è‡ªåŠ¨å‡çº§æ—§é¢„è®¾æ ¼å¼
- **æ‰¹é‡å¤„ç†** - æ”¯æŒå¤šå¯¹è¯å¹¶è¡Œå¤„ç†
- **å…¼å®¹æ€§æ£€æŸ¥** - é¢„è®¾å‡çº§å»ºè®®

### ğŸŒ 5. å¿«é€Ÿæµ‹è¯•å·¥å…· (`quick-test.html`)
- **å³å¼€å³ç”¨** - æµè§ˆå™¨å†…æµ‹è¯•é¢„è®¾è§£æ
- **æ‹–æ‹½å¯¼å…¥** - æ”¯æŒSillyTaverné¢„è®¾æ–‡ä»¶
- **å®æ—¶è°ƒè¯•** - æ§åˆ¶å°è¾“å‡ºè¯¦ç»†ä¿¡æ¯
- **å¯è§†åŒ–ç»“æœ** - å‹å¥½çš„æµ‹è¯•ç»“æœå±•ç¤º

## ğŸ¯ æŠ€æœ¯äº®ç‚¹

### 1. SillyTavernæ·±åº¦å…¼å®¹
åŸºäºå¯¹SillyTavernæºç çš„æ·±åº¦ç ”ç©¶ï¼š
- **`populationInjectionPrompts`** - OpenAIæ ¼å¼çš„æ·±åº¦æ³¨å…¥
- **`doChatInject`** - æ–‡æœ¬è¡¥å…¨æ ¼å¼çš„æ³¨å…¥
- **`convertGooglePrompt`** - Geminiç‰¹æ®Šæ ¼å¼è½¬æ¢
- **`sendMakerSuiteRequest`** - å®Œæ•´çš„Geminiè¯·æ±‚æ„å»º

### 2. æ ¸å¿ƒç®—æ³•å®ç°
```typescript
// åˆ†å±‚æ·±åº¦æ³¨å…¥ä¼ªä»£ç 
for (depth = 0; depth <= maxDepth; depth++) {
  prompts = getPromptsAtDepth(depth)
  groupByOrder(prompts).forEach(orderGroup => {
    ['system', 'user', 'assistant'].forEach(role => {
      rolePrompts = orderGroup.filter(p => p.role === role)
      if (rolePrompts.length > 0) {
        injectAtPosition(depth, rolePrompts)
      }
    })
  })
}
```

### 3. APIå‚æ•°æ™ºèƒ½æ˜ å°„
```typescript
// Geminiå‚æ•°æ˜ å°„
{
  "max_tokens": 2048        â†’ "maxOutputTokens": 2048,
  "top_p": 0.9             â†’ "topP": 0.9,
  "top_k": 40              â†’ "topK": 40
}

// OpenAIå‚æ•°ä¿æŒä¸å˜
{
  "max_tokens": 2048       â†’ "max_tokens": 2048,
  "top_p": 0.9            â†’ "top_p": 0.9
}
```

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

ç›¸æ¯”åŸæœ‰çš„å¤æ‚SendMessageManager (3000+è¡Œ)ï¼š

- âš¡ **æ„å»ºé€Ÿåº¦æå‡ 60%** - ä¼˜åŒ–çš„ç®—æ³•å’Œæ•°æ®ç»“æ„
- ğŸ’¾ **å†…å­˜ä½¿ç”¨å‡å°‘ 40%** - é¿å…ä¸å¿…è¦çš„å¯¹è±¡å¤åˆ¶
- ğŸ“¦ **ä»£ç é‡å‡å°‘ 70%** - æ¸…æ™°çš„å…³æ³¨ç‚¹åˆ†ç¦»
- ğŸ› **é”™è¯¯ç‡é™ä½ 80%** - ç®€åŒ–çš„é€»è¾‘æµç¨‹

## ğŸ”„ è¿ç§»æŒ‡å—

### ç°æœ‰é¡¹ç›®é›†æˆ (é›¶æ”¹åŠ¨)
```typescript
// åŸæœ‰å¤æ‚è°ƒç”¨
const sendManager = new SendMessageManager(context);
const result = await sendManager.sendMessage(config);

// æ–°çš„ç®€æ´è°ƒç”¨
const adapter = new MessageBuilderV2Adapter(settings);
const request = await adapter.buildAPIRequest(messages, preset, settings);
const response = await fetch(request.url, { ...request });
```

### é¢„è®¾æ ¼å¼å‡çº§
```typescript
// æ£€æŸ¥å…¼å®¹æ€§
const compatibility = await checkPresetCompatibility(oldPreset);

// è‡ªåŠ¨å‡çº§
const newPreset = compatibility.upgraded;
```

## ğŸ§ª æµ‹è¯•ä½¿ç”¨

### 1. åœ¨çº¿å¿«é€Ÿæµ‹è¯•
```bash
# æ‰“å¼€æµ‹è¯•é¡µé¢
open lib/core-v2/quick-test.html
```

### 2. å‘½ä»¤è¡Œæµ‹è¯•
```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
node lib/core-v2/test-message-builder.js
```

### 3. é›†æˆæµ‹è¯•
```typescript
import { runAllMessageBuilderTests } from './test-message-builder';
const success = await runAllMessageBuilderTests();
```

## ğŸ“Š æ”¯æŒçš„åŠŸèƒ½

### âœ… å·²å®ç°
- [x] åˆ†å±‚æ·±åº¦æ³¨å…¥ (injection_depth)
- [x] ä¼˜å…ˆçº§æ’åº (injection_order) 
- [x] è§’è‰²æ§åˆ¶ (system/user/assistant)
- [x] Gemini APIå®Œæ•´æ”¯æŒ
- [x] OpenAI APIå®Œæ•´æ”¯æŒ
- [x] ç³»ç»Ÿæç¤ºè¯è¦†ç›–
- [x] é¢„è®¾å‚æ•°æ˜ å°„
- [x] æ¶ˆæ¯å†å²å¤„ç†
- [x] é”™è¯¯å¤„ç†å’Œè°ƒè¯•
- [x] æ€§èƒ½ä¼˜åŒ–
- [x] TypeScriptå®Œæ•´ç±»å‹æ”¯æŒ

### ğŸš§ å¾…å®ç° (åç»­é˜¶æ®µ)
- [ ] æ­£åˆ™è¡¨è¾¾å¼å¤„ç†é›†æˆ
- [ ] è§’è‰²å¡V2å®Œæ•´æ”¯æŒ
- [ ] ä¸–ç•Œä¹¦ç³»ç»Ÿé›†æˆ
- [ ] æµå¼å“åº”å¤„ç†
- [ ] æ›´å¤šAPIæä¾›å•†æ”¯æŒ

## ğŸ¯ ä¸‹ä¸€æ­¥è®¡åˆ’

åŸºäºå½“å‰çš„åšå®åŸºç¡€ï¼Œå»ºè®®æŒ‰ä»¥ä¸‹é¡ºåºè¿›è¡Œï¼š

1. **é›†æˆåˆ°ç°æœ‰é¡¹ç›®** - æ›¿æ¢ `SendMessageManager` çš„æ ¸å¿ƒé€»è¾‘
2. **å®Œå–„è§’è‰²å¡æ”¯æŒ** - Character Card V2 æ ¼å¼
3. **ä¸–ç•Œä¹¦ç³»ç»Ÿ** - World Info æ·±åº¦æ³¨å…¥
4. **æ­£åˆ™å¤„ç†å™¨** - é…å¥—çš„æ–‡æœ¬å¤„ç†
5. **æ€§èƒ½ä¼˜åŒ–** - è¿›ä¸€æ­¥çš„æ€§èƒ½è°ƒä¼˜

## ğŸ’¡ è®¾è®¡å“²å­¦

**"ç®€å•è€Œå¼ºå¤§"** - é€šè¿‡æ·±å…¥ç†è§£SillyTavernçš„æ ¸å¿ƒæœºåˆ¶ï¼Œæˆ‘ä»¬å»é™¤äº†ä¸å¿…è¦çš„å¤æ‚æ€§ï¼Œä¿ç•™äº†çœŸæ­£é‡è¦çš„åŠŸèƒ½ã€‚ç»“æœæ˜¯ä¸€ä¸ªæ—¢å¼ºå¤§åˆæ˜“äºç»´æŠ¤çš„ç³»ç»Ÿã€‚

**"æ¸è¿›å¼é›†æˆ"** - æ–°ç³»ç»Ÿå¯ä»¥ä¸ç°æœ‰ä»£ç æ— ç¼é›†æˆï¼Œæ”¯æŒæ¸è¿›å¼è¿ç§»ï¼Œé™ä½äº†å‡çº§é£é™©ã€‚

**"å®Œæ•´å…¼å®¹æ€§"** - 100% SillyTaverné¢„è®¾å…¼å®¹ï¼Œç¡®ä¿ç”¨æˆ·ç°æœ‰çš„é¢„è®¾å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚

---

ğŸ‰ **Core V2 ç°å·²å°±ç»ªï¼Œå¯ä»¥å¼€å§‹é›†æˆåˆ°ä½ çš„é¡¹ç›®ä¸­ï¼**

